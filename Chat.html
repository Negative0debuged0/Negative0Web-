<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zer0's Chat</title>
  <style>
    /* Fullscreen Styling */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #a8e063, #56ab2f);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: #fff;
      flex-direction: column;
    }

    /* Navbar Styling */
    .navbar {
      width: 100%;
      background-color: #333;
      padding: 10px 20px;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 1000;
    }
    .navbar a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      padding: 10px 15px;
      transition: background 0.3s;
    }
    .navbar a:hover {
      background-color: #575757;
    }

    /* Chat Container Styling */
    .chat-container {
      background: rgba(0, 0, 0, 0.7);
      width: 80%;
      max-width: 900px;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 80px; /* Add space for the navbar */
    }
    h1 {
      margin-bottom: 20px;
      font-size: 28px;
    }

    /* Message Display Area */
    #messages {
      width: 100%;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      margin-bottom: 20px;
      color: #fff;
    }
    .message {
      padding: 10px;
      margin-bottom: 15px;
      background: rgba(255, 255, 255, 0.15);
      border-radius: 6px;
      position: relative;
      text-align: left;
    }
    .timestamp {
      font-size: 0.8em;
      color: #ddd;
      position: absolute;
      right: 10px;
      top: 10px;
    }
    .reply-indicator {
      font-size: 0.9em;
      color: #c9f5d7;
      margin-bottom: 5px;
      padding: 5px;
      border-left: 3px solid #56ab2f;
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    /* Reactions and Reply Styling */
    .reactions {
      cursor: pointer;
      margin-top: 8px;
    }
    .reactions span {
      margin-right: 10px;
    }
    .reaction-count {
      margin-left: 5px;
    }
    .reply {
      cursor: pointer;
      color: #4CAF50;
    }

    /* Input and Button Styling */
    textarea, input[type="text"], input[type="password"] {
      width: 100%;
      padding: 15px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      outline: none;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
    }
    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background-color: #4CAF50;
      color: white;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #388E3C;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <a href="#">Home</a>
  </div>

  <!-- Chat Container -->
  <div class="chat-container">
    <h1>Zer0's Chat</h1>

    <input type="text" id="nameInput" placeholder="Enter your name" required>
    <button id="setNameButton">Set Name</button>

    <div id="adminLogin">
      <input type="password" id="adminPassword" placeholder="Enter admin password">
      <button id="adminLoginButton">Login as Admin</button>
    </div>
  
    <div id="messages"></div>
    <textarea id="messageInput" placeholder="Type a message..." rows="4"></textarea><br>
    <button id="sendMessageButton">Send Message</button>
  </div>

  <script>
    const GIST_API_URL = 'https://api.github.com/gists/6686b37f704607d66c455ceefef7fec6';
    const GH_TOKEN = 'secrets.GH_TOKEN'; // Use GitHub token securely
    const ADMIN_PASSWORD = "10242048"; // Admin password
    
    let currentMessages = [];
    let userName = '';
    let isAdmin = false;
    let replyingToMessage = null;
    let lastFetchTime = ''; // For ETag-based conditional fetching

    function setName() {
      const nameInput = document.getElementById('nameInput');
      userName = nameInput.value.trim();
      if (userName) {
        nameInput.disabled = true;
        document.getElementById('setNameButton').disabled = true;
      }
    }

    function adminLogin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        alert("Admin access granted.");
      } else {
        alert("Incorrect password.");
      }
    }

    function fetchMessages() {
      fetch(GIST_API_URL, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${GH_TOKEN}`, // Include the GitHub token
          'Accept': 'application/vnd.github.v3+json', // Ensure GitHub API returns JSON
        },
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to fetch Gist: ${response.statusText}`);
        }
        return response.json(); // Parse response as JSON
      })
      .then(data => {
        const gistContent = data.files['chat.json']?.content;
        if (gistContent) {
          try {
            const messages = JSON.parse(gistContent);  // Parse the JSON content of the Gist file
            currentMessages = messages.messages || [];
            displayMessages(currentMessages);
          } catch (err) {
            console.error('Error parsing messages:', err);
          }
        } else {
          console.error('chat.json file not found in Gist.');
        }
      })
      .catch(err => {
        console.error('Error fetching messages:', err);
      });
    }

    function displayMessages(messages) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      messages.forEach((message, index) => {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message');
        
        if (message.replyTo) {
          const replyDiv = document.createElement('div');
          replyDiv.classList.add('reply-indicator');
          replyDiv.innerHTML = `<strong>Reply to:</strong> ${message.replyTo.sender}: "${message.replyTo.text}"`;
          messageDiv.appendChild(replyDiv);
        }
        
        messageDiv.innerHTML += `
          <strong>${message.sender}</strong>: ${message.text}
          <div class="timestamp">${new Date(message.timestamp).toLocaleString()}</div>
          <div class="reactions">${renderReactions(message.reactions, index)}</div>
          <span class="reply" onclick="replyToMessage(${index})">Reply</span>
        `;
        
        messagesDiv.appendChild(messageDiv);
      });
    }

    function renderReactions(reactions, index) {
      const reactionTypes = ['👍', '❤️', '😂', '😮', '😢', '😡'];
      return reactionTypes.map(type => {
        const count = reactions[type] || 0;
        return `
          <span onclick="addReaction(${index}, '${type}')">${type}</span>
          <span class="reaction-count">${count}</span>
        `;
      }).join(' ');
    }

    function addReaction(index, reaction) {
      const message = currentMessages[index];
      if (!message.reactions) message.reactions = {};
      message.reactions[reaction] = (message.reactions[reaction] || 0) + 1;
      updateMessages();
    }

    function replyToMessage(index) {
      replyingToMessage = currentMessages[index];
      document.getElementById('messageInput').value = `@${replyingToMessage.sender} `;
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();
      if (messageText) {
        const newMessage = {
          sender: userName,
          text: messageText,
          timestamp: new Date().toISOString(),
          reactions: {},
          replyTo: replyingToMessage ? { sender: replyingToMessage.sender, text: replyingToMessage.text } : null,
        };
        currentMessages.push(newMessage);
        messageInput.value = '';
        updateMessages();
      }
    }

    function updateMessages() {
      const messagesJson = JSON.stringify({ messages: currentMessages });
      fetch(GIST_API_URL, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${GH_TOKEN}`,
          'Accept': 'application/vnd.github.v3+json',
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          files: {
            'chat.json': {
              content: messagesJson,
            }
          }
        }),
      })
      .then(response => response.json())
      .then(data => {
        console.log('Messages updated successfully', data);
      })
      .catch(err => {
        console.error('Error updating messages:', err);
      });
    }

    // Event Listeners
    document.getElementById('setNameButton').addEventListener('click', setName);
    document.getElementById('adminLoginButton').addEventListener('click', adminLogin);
    document.getElementById('sendMessageButton').addEventListener('click', sendMessage);

    // Fetch messages on page load
    fetchMessages();
  </script>
</body>
</html>
